import clamp from"/utils/clamp.js";import{easeOutQuint}from"/utils/easing.js";import{getObserver}from"/index.js";export default class AnimatedText{static get selector(){return".animated-text"}constructor(t){this.block=t,this.splitted=this.block.dataset.splitted,this.transitionDuration=1600,this.raf=[],this.animationStartTimestamp=[],this.onReady=this.onReady.bind(this),this.show=this.show.bind(this),this.getRow=this.getRow.bind(this),this.setupRows=this.setupRows.bind(this),this.animate=this.animate.bind(this),this.setupRows()}onResize(){this.setupRows()}onReady(){this.block.dataset.intersectionRatio=.8,getObserver().register(this.block.dataset.instanceIndex,this.show,this.block)}animate(t,i,e){this.animationStartTimestamp[e]||(this.animationStartTimestamp[e]=t);let s=easeOutQuint(clamp((t-this.animationStartTimestamp[e])/this.transitionDuration,0,1));i.style.transform=`translate3d(0, ${110*(1-s)}%, 0)`,s>.8&&!i.classList.contains("animated-text__row--entering")&&i.classList.add("animated-text__row--entering"),s<1?this.raf[e]=window.requestAnimationFrame(t=>{this.animate(t,i,e)}):(this.animationStartTimestamp[e]=null,window.cancelAnimationFrame(this.raf[e]),this.raf[e]=null,this.block.classList.add("animated-text--in-view"),i.classList.remove("animated-text__row--entering"),i.classList.add("animated-text__row--in-view"))}show(){getObserver().unregister(this.block),this.block.querySelectorAll(".animated-text__row").forEach((t,i)=>{setTimeout(()=>{this.raf[i]=window.requestAnimationFrame(e=>{this.animate(e,t,i)})},300*i)})}getRow(t){for(this.block.textContent=t;this.block.scrollWidth>this.block.offsetWidth;){let i=t.lastIndexOf(" ");t=t.substring(0,i),this.block.textContent=t}return this.block.textContent}setupRows(){if("true"===this.splitted)return;let t=this.block.textContent,i=[];for(;t.length>0;){let e=this.getRow(t);i.push(e),t=t.substring(e.length,t.length)}this.block.innerHTML="",i.forEach(t=>{let i=document.createElement("span");i.classList.add("animated-text__wrapper");let e=document.createElement("span");e.classList.add("animated-text__row"),e.textContent=t,i.appendChild(e),this.block.appendChild(i)})}}